/**********************
* @license
* The MIT License (MIT)
*
* Copyright (c) 2014 David Arvelo
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
**********************/
!function(e,t){var n;if("undefined"!=typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&"object"==typeof define.amd)define(t);else{try{n=Function("return this")()||(42,eval)("this")}catch(i){n=window}n[e]=t()}}("AnimationLoop",function(){"use strict";function e(e,t){return t==={}.toString.call(e).slice(8,-1)}function t(t,n){return!e(t,n)}function n(t){var n=[];return t.forEach(function(t){if(e(t,"Array")){var i=n.length,a=t.length,r=-1;for(n.length+=a;++r<a;)n[i++]=t[r]}else n.push(t)}),n}var i=function(e){return Array.isArray(e)?e:Array.from(e)},a=function(e,t,n){t&&Object.defineProperties(e,t),n&&Object.defineProperties(e.prototype,n)},r=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame}(),s=function(){return window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame}(),o=function(){function t(e){if(!(this instanceof t))return new t(e);this.canceled=!1,this.completed=!1,this.paused=!1,this.autonomous=!1,this.startTime=null;for(var n in e)e.hasOwnProperty(n)&&(this[n]=e[n]);this.autonomous&&(this.rafId=null),this.paused||this.start()}return a(t,null,{cancelRAF:{value:function(){s(this.rafId),this.rafId=null},writable:!0,enumerable:!0,configurable:!0},start:{value:function(){return this.completed||this.canceled?this:(this.autonomous&&(this.cancelRAF(),this.rafId=r(this.burnFrame.bind(this))),this.paused=!1,this)},writable:!0,enumerable:!0,configurable:!0},burnFrame:{value:function(e){this.updateState(e),this.rafId=r(this.cycle.bind(this))},writable:!0,enumerable:!0,configurable:!0},pause:{value:function(){return this.completed||this.canceled?this:(this.autonomous&&this.cancelRAF(),this.paused=!0,this)},writable:!0,enumerable:!0,configurable:!0},cancel:{value:function(){return this.autonomous&&this.cancelRAF(),this.canceled=!0,this.completed=!0,this._oncomplete(),this},writable:!0,enumerable:!0,configurable:!0},complete:{value:function(){if(this.autonomous&&this.cancelRAF(),e(this.done,"Function")){var t,n=this.args||[];(t=this).done.apply(t,i(n))}return this.completed=!0,this._oncomplete(),this},writable:!0,enumerable:!0,configurable:!0},updateState:{value:function(e){var t=this.previousState;return t?(t=this.previousState=this.state,void(this.state={now:e,lastNow:t.now,deltaT:e-t.now,runningTime:t.runningTime,progress:t.progress})):(this.startTime=e,t={},t.now=e,t.lastNow=e,t.runningTime=0,t.deltaT=0,t.progress=0,void(this.state=this.previousState=t))},writable:!0,enumerable:!0,configurable:!0},updateProgress:{value:function(){var e=this.state;e.runningTime+=e.deltaT,this.duration&&(e.progress=Math.max(0,Math.min(1,e.runningTime/this.duration)))},writable:!0,enumerable:!0,configurable:!0},cycle:{value:function(t){var n;if(this.autonomous){var a=this.args||[],s=this.state,o=t-this.lastNow;if(this.pauseThreshold&&o>=this.pauseThreshold)return void(this.rafId=r(this.burnFrame.bind(this)));if(this.rafId=r(this.cycle.bind(this)),this.updateState(t),this.updateProgress(),e(this.before,"Function")){var u;(u=this).before.apply(u,i(a))}this.paused||this.canceled||this.completed||((n=this).render.apply(n,i(a)),this.paused||this.canceled||this.completed||1===s.progress&&this.complete())}},writable:!0,enumerable:!0,configurable:!0}}),t}(),u=["before","render","done","args","duration","paused","pauseThreshold","autonomous"],l=function(){function l(t){return this instanceof l?(t=t||{},this.animations=[],this.remaining=0,this.completed=!1,this.registry={},this.autonomous=t.autonomous||!1,this.autonomous||(this.paused=!1,this.rafId=null),void(this.pauseThreshold=e(t.pauseThreshold,"Undefined")?!1:t.pauseThreshold)):new l(t)}return a(l,null,{createAnimations:{value:function(){for(var e=this,t=arguments.length,i=Array(t),a=0;t>a;a++)i[a]=arguments[a];return 0===i.length?[]:(i=n(i),i.map(function(t){return t=e.getScrubbedOptions(t),t.autonomous=t.autonomous||e.autonomous,t.pauseThreshold=t.pauseThreshold||e.pauseThreshold,t._oncomplete=e._animationComplete.bind(e),new o(t)}))},writable:!0,enumerable:!0,configurable:!0},getScrubbedOptions:{value:function(n){var i={};if(n=e(n,"Object")?n:e(n,"Function")?{render:n}:null,e(n,"Null"))throw new Error("Options to AnimationLoop are not of a supported type.");if(t(n.render,"Function"))throw new Error("There was no render function supplied to the AnimationLoop.");return u.forEach(function(e){n.hasOwnProperty(e)&&t(n[e],"Undefined")&&(i[e]=n[e])}),i.args&&t(i.args,"Array")&&(i.args=[i.args]),i},writable:!0,enumerable:!0,configurable:!0},cancelRAF:{value:function(){s(this.rafId),this.rafId=null},writable:!0,enumerable:!0,configurable:!0},start:{value:function(){return this.animations.forEach(function(e){return e.start()}),this.autonomous||(this.cancelRAF(),this.rafId=r(this.burnFrame.bind(this)),this.paused=!1),this},writable:!0,enumerable:!0,configurable:!0},burnFrame:{value:function(e){this.autonomous||0===this.remaining||(this.updateState(e),this.animations.forEach(function(t){t.autonomous||t.paused||t.completed||t.canceled||t.updateState(e)}),this.rafId=r(this.cycle.bind(this)))},writable:!0,enumerable:!0,configurable:!0},pause:{value:function(){return this.animations.forEach(function(e){return e.pause()}),this.autonomous||(this.cancelRAF(),this.paused=!0),this},writable:!0,enumerable:!0,configurable:!0},cancel:{value:function(){return this.animations.forEach(function(e){return e.cancel()}),this.autonomous&&this.cancelRAF(),this},writable:!0,enumerable:!0,configurable:!0},_animationComplete:{value:function(){this.remaining--,0===this.remaining&&(this.completed=!0,this.autonomous||this.cancelRAF(),e(this.oncomplete,"Function")&&this.oncomplete())},writable:!0,enumerable:!0,configurable:!0},add:{value:function(){for(var e,t=arguments.length,n=Array(t),a=0;t>a;a++)n[a]=arguments[a];this.autonomous||this.paused||0!==this.remaining||this.start();var r=(e=this).createAnimations.apply(e,i(n));return this.animations=this.animations.concat(r),this.remaining+=r.length,this.completed=0===this.remaining?this.completed:!1,r},writable:!0,enumerable:!0,configurable:!0},clearCompleted:{value:function(){for(var e=this.animations,t=[],n=e.length-1;n>=0;--n){var i=e[n];(i.completed||i.canceled)&&(t=t.concat(e.splice(n,1)))}return t.reverse(),t},writable:!0,enumerable:!0,configurable:!0},addEventListener:{value:function(e,t,n){var i=this.registry[e]||(this.registry[e]=[]);i.push([t,n])},writable:!0,enumerable:!0,configurable:!0},removeEventListener:{value:function(e,t,n){var i,a=arguments.length;if(1===a)return void delete this.registry[e];i=this.registry[e]||[];for(var r=i.length-1;r>=0;--r){var s=i[r][0],o=i[r][1];s===t&&(2===a||o===n)&&i.splice(r,1)}},writable:!0,enumerable:!0,configurable:!0},trigger:{value:function(e){var t=this.registry[e]||[];t.forEach(function(e){var t=e[0],n=e[1];t.call(n)})},writable:!0,enumerable:!0,configurable:!0},oncomplete:{value:function(){this.trigger("complete")},writable:!0,enumerable:!0,configurable:!0},updateState:{value:function(e){this._lastNow=this._lastNow||e,this._deltaT=e-this._lastNow,this._lastNow=e},writable:!0,enumerable:!0,configurable:!0},cycle:{value:function(t){if(!this.autonomous&&0!==this.remaining){var n=t-this._lastNow,a=this.animations;if(this.pauseThreshold&&n>=this.pauseThreshold)return void(this.rafId=r(this.burnFrame.bind(this)));this.rafId=r(this.cycle.bind(this)),this.updateState(t),a=a.filter(function(n){if(n.autonomous||n.paused||n.canceled||n.completed)return!1;var a=n.args||[];return n.updateState(t),n.updateProgress(),e(n.before,"Function")&&n.before.apply(n,i(a)),n.autonomous||n.paused||n.canceled||n.completed?!1:!0}),a.forEach(function(e){var t=e.args||[];e.render.apply(e,i(t)),e.paused||e.canceled||e.completed||1===e.state.progress&&e.complete()})}},writable:!0,enumerable:!0,configurable:!0}}),l}();return l});