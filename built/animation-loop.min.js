/**********************
* @license
* The MIT License (MIT)
*
* Copyright (c) 2014 David Arvelo
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
**********************/
!function(t,e){var i;if("undefined"!=typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&"object"==typeof define.amd)define(e);else{try{i=Function("return this")()||(42,eval)("this")}catch(n){i=window}i[t]=e()}}("AnimationLoop",function(){"use strict";function t(t,e){return e==={}.toString.call(t).slice(8,-1)}function e(e,i){return!t(e,i)}function i(e){for(var i,n=[],o=e[Symbol.iterator]();!(i=o.next()).done;){var s=i.value;if(t(s,"Array")){var r=n.length,a=s.length,u=-1;for(n.length+=a;++u<a;)n[r++]=s[u]}else n.push(s)}return n}var n=Array.prototype.slice,o=function(t){return Array.isArray(t)?t:Array.from(t)},s=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame}(),r=function(){return window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame}(),a=function(){var e=function i(t){if(!(this instanceof i))return new i(t);this.canceled=!1,this.completed=!1,this.paused=!1,this.autonomous=!1,this.startTime=null;for(var e,n=Object.keys(t)[Symbol.iterator]();!(e=n.next()).done;){var o=e.value;this[o]=t[o]}this.autonomous&&(this.rafId=null),this.paused||this.start()};return e.prototype.cancelRAF=function(){r(this.rafId),this.rafId=null},e.prototype.start=function(){return this.completed||this.canceled?this:(this.autonomous&&(this.cancelRAF(),this.rafId=s(this.burnFrame.bind(this))),this.paused=!1,this)},e.prototype.burnFrame=function(t){this.updateState(t),this.rafId=s(this.cycle.bind(this))},e.prototype.pause=function(){return this.completed||this.canceled?this:(this.autonomous&&this.cancelRAF(),this.paused=!0,this)},e.prototype.cancel=function(){return this.autonomous&&this.cancelRAF(),this.canceled=!0,this.completed=!0,this._oncomplete(),this},e.prototype.complete=function(){if(this.autonomous&&this.cancelRAF(),t(this.done,"Function")){var e=this.args||[];this.done.apply(this,o(e))}return this.completed=!0,this._oncomplete(),this},e.prototype.updateState=function(t){var e=this.previousState;return e?(e=this.previousState=this.state,void(this.state={now:t,lastNow:e.now,deltaT:t-e.now,runningTime:e.runningTime,progress:e.progress})):(this.startTime=t,e={},e.now=t,e.lastNow=t,e.runningTime=0,e.deltaT=0,e.progress=0,void(this.state=this.previousState=e))},e.prototype.updateProgress=function(){var t=this.state;t.runningTime+=t.deltaT,this.duration&&(t.progress=Math.max(0,Math.min(1,t.runningTime/this.duration)))},e.prototype.cycle=function(e){if(this.autonomous){var i=this.args||[],n=this.state,r=e-this.lastNow;if(this.pauseThreshold&&r>=this.pauseThreshold)return void(this.rafId=s(this.burnFrame.bind(this)));this.rafId=s(this.cycle.bind(this)),this.updateState(e),this.updateProgress(),t(this.before,"Function")&&this.before.apply(this,o(i)),this.paused||this.canceled||this.completed||(this.render.apply(this,o(i)),this.paused||this.canceled||this.completed||1===n.progress&&this.complete())}},e}(),u=["before","render","done","args","duration","paused","pauseThreshold","autonomous"],h=function(){var h=function c(e){return this instanceof c?(e=e||{},this.animations=[],this.remaining=0,this.completed=!1,this.registry={},this.autonomous=e.autonomous||!1,this.autonomous||(this.paused=!1,this.rafId=null),void(this.pauseThreshold=t(e.pauseThreshold,"Undefined")?!1:e.pauseThreshold)):new c(e)};return h.prototype.createAnimations=function(){var t=this,e=n.call(arguments);return 0===e.length?[]:(e=i(e),e.map(function(e){return e=t.getScrubbedOptions(e),e.autonomous=e.autonomous||t.autonomous,e.pauseThreshold=e.pauseThreshold||t.pauseThreshold,e._oncomplete=t._animationComplete.bind(t),new a(e)}))},h.prototype.getScrubbedOptions=function(i){var n={};if(i=t(i,"Object")?i:t(i,"Function")?{render:i}:null,t(i,"Null"))throw new Error("Options to AnimationLoop are not of a supported type.");if(e(i.render,"Function"))throw new Error("There was no render function supplied to the AnimationLoop.");for(var o,s=u[Symbol.iterator]();!(o=s.next()).done;){var r=o.value;i.hasOwnProperty(r)&&e(i[r],"Undefined")&&(n[r]=i[r])}return n},h.prototype.cancelRAF=function(){r(this.rafId),this.rafId=null},h.prototype.start=function(){return this.animations.forEach(function(t){return t.start()}),this.autonomous||(this.cancelRAF(),this.rafId=s(this.burnFrame.bind(this)),this.paused=!1),this},h.prototype.burnFrame=function(t){this.autonomous||0===this.remaining||(this.updateState(t),this.animations.forEach(function(e){e.autonomous||e.paused||e.completed||e.canceled||e.updateState(t)}),this.rafId=s(this.cycle.bind(this)))},h.prototype.pause=function(){return this.animations.forEach(function(t){return t.pause()}),this.autonomous||(this.cancelRAF(),this.paused=!0),this},h.prototype.cancel=function(){return this.animations.forEach(function(t){return t.cancel()}),this.autonomous&&this.cancelRAF(),this},h.prototype._animationComplete=function(){this.remaining--,0===this.remaining&&(this.completed=!0,this.autonomous||this.cancelRAF(),t(this.oncomplete,"Function")&&this.oncomplete())},h.prototype.add=function(){var t=n.call(arguments);this.autonomous||this.paused||0!==this.remaining||this.start();var e=this.createAnimations.apply(this,o(t));return this.animations=this.animations.concat(e),this.remaining+=e.length,this.completed=0===this.remaining?this.completed:!1,e},h.prototype.clearCompleted=function(){for(var t=this.animations,e=[],i=t.length-1;i>=0;--i){var n=t[i];(n.completed||n.canceled)&&(e=e.concat(t.splice(i,1)))}return e.reverse(),e},h.prototype.addEventListener=function(t,e,i){var n=this.registry[t]||(this.registry[t]=[]);n.push([e,i])},h.prototype.removeEventListener=function(t,e,i){var n,s=arguments.length;if(1===s)return void delete this.registry[t];n=this.registry[t]||[];for(var r=n.length-1;r>=0;--r){var a=o(n[r]),u=a[0],h=a[1];u===e&&(2===s||h===i)&&n.splice(r,1)}},h.prototype.trigger=function(t){var e=this.registry[t]||[];e.forEach(function(t){var e=o(t),i=e[0],n=e[1];i.call(n)})},h.prototype.oncomplete=function(){this.trigger("complete")},h.prototype.updateState=function(t){this._lastNow=this._lastNow||t,this._deltaT=t-this._lastNow,this._lastNow=t},h.prototype.cycle=function(e){if(!this.autonomous&&0!==this.remaining){var i=e-this._lastNow,n=this.animations;if(this.pauseThreshold&&i>=this.pauseThreshold)return void(this.rafId=s(this.burnFrame.bind(this)));this.rafId=s(this.cycle.bind(this)),this.updateState(e),n=n.filter(function(i){if(i.autonomous||i.paused||i.canceled||i.completed)return!1;var n=i.args||[];return i.updateState(e),i.updateProgress(),t(i.before,"Function")&&i.before.apply(i,o(n)),i.autonomous||i.paused||i.canceled||i.completed?!1:!0}),n.forEach(function(t){var e=t.args||[];t.render.apply(t,o(e)),t.paused||t.canceled||t.completed||1===t.state.progress&&t.complete()})}},h}();return h});